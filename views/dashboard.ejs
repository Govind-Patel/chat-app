<%- include('layout/header.ejs') %>

  <h2 class="mb-4"> Hii, <%= user.name %>
  </h2>
  <div class="row">
    <div class="col-md-4">
      <ul class="list-group">
        <% if(users.length>0){
          for(let i=0;i<users.length;i++){ %>
            <li class="list-group-item list-group-item-dark cursor-pointer user-list" data-id="<%= users[i]['_id'] %>">
              <img src="<%= 'http://localhost:3000/' + users[i]['image'] %>" height="50px" width="50px" alt="">
              <%= users[i].name %>

                <% if (users[i]['is_online']==1) { %>
                  <sup class="online-status" id="<%= users[i]['_id'] %>-status">Online</sup>
                  <% } else { %>
                    <sup class="offline-status" id="<%= users[i]['_id'] %>-status">Offline</sup>
                    <% } %>

            </li>
            <% } } %>
      </ul>


    </div>
    <div class="col-md-8">
      <h3 class="start-head">Click to Start Chat</h3>
      <div class="chat-section">
        <div id="chat-container">

          <div class="distance-user-chat">
            <h5>Hi</h5>
          </div>
        </div>
        <form action="" id="chat-form">
          <input type="text" name="message" id="message" class="border" placeholder="Enter Message" required>
          <input type="submit" name="" id="" value="Sned Messagw" class="btn btn-primary">
        </form>
      </div>
    </div>
  </div>
  <script>
    var sender_id = '<%= user._id %>';
    var receiver_id;
    var socket = io('/user-name', {
      auth: {
        token: sender_id
      }
    });

    $(document).ready(function ($) {
      $('.user-list').click(function () {
        var userId = $(this).attr('data-id');
        var receiver_id = userId;
        $('.start-head').hide();
        $('.chat-section').show();
      });

      // update user online user status
      socket.on('getOnlineUser', function (data) {
        $('#' + data.user_id + '-status').text('Online');
        $('#' + data.user_id + '-status').removeClass('offline-status');
        $('#' + data.user_id + '-status').addClass('online-status');
      });

      //update user offline user status
      socket.on('getOfflineUser', function (data) {
        $('#' + data.user_id + '-status').text('Offline');
        $('#' + data.user_id + '-status').addClass('offline-status');
        $('#' + data.user_id + '-status').removeClass('online-status');
      });

    // chat save of user 
    $('#chat-form').submit(function(event) {
      event.preventDefault();
      var message = $('#message').val();
      $.ajax({
        url: '/save-chat',
        type: 'post',
        data: { sender_id: sender_id, receiver_id: receiver_id, message: message },
        success:function(data){
          if(data.message){
            $('#message').val('');
            let chat = data.message;
            let html = `
                <div class="current-user-chat">
                  <h5 >`+ chat + `</h5>
                </div>
            `;
          }else{
            alert(data.message);
          }
        }
      });
    });
  });
  </script>
  <%- include('layout/footer.ejs') %>